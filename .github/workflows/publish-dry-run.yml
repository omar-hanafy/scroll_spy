name: Pub Dry-Run (scroll_spy)

on:
  pull_request:
    branches: [main, dev]

permissions:
  contents: read

env:
  PACKAGE_DIR: .

jobs:
  pub-dry-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        working-directory: ${{ env.PACKAGE_DIR }}
        run: flutter pub get

      - name: Enforce version bump
        working-directory: ${{ env.PACKAGE_DIR }}
        run: |
          set -euo pipefail
          base_sha="${{ github.event.pull_request.base.sha }}"
          base_version=$(git show "$base_sha:pubspec.yaml" | awk -F': ' '/^version: /{print $2}')
          head_version=$(awk -F': ' '/^version: /{print $2}' pubspec.yaml)
          if [ -z "$base_version" ] || [ -z "$head_version" ]; then
            echo "Unable to read version from pubspec.yaml."
            exit 1
          fi
          if [ "$base_version" = "$head_version" ]; then
            echo "pubspec.yaml version not bumped (base: $base_version, head: $head_version)."
            exit 1
          fi
          echo "Version bump detected: $base_version -> $head_version"

      - name: Validate version channel for target branch
        working-directory: ${{ env.PACKAGE_DIR }}
        run: |
          set -euo pipefail
          base_ref="${{ github.event.pull_request.base.ref }}"
          version=$(awk -F': ' '/^version: /{print $2}' pubspec.yaml)
          if [ -z "$version" ]; then
            echo "Unable to read version from pubspec.yaml."
            exit 1
          fi
          if [ "$base_ref" = "main" ] && [[ "$version" == *-* ]]; then
            echo "Main requires a stable version (no pre-release): $version"
            exit 1
          fi
          if [ "$base_ref" = "dev" ] && [[ "$version" != *-* ]]; then
            echo "Dev requires a pre-release version: $version"
            exit 1
          fi

      - name: Pub publish dry-run
        working-directory: ${{ env.PACKAGE_DIR }}
        run: flutter pub publish --dry-run

      - name: Install pana
        run: |
          dart pub global activate pana
          echo "$HOME/.pub-cache/bin" >> "$GITHUB_PATH"

      - name: Run pana (full score required)
        working-directory: ${{ env.PACKAGE_DIR }}
        run: |
          set -euo pipefail
          output=$(pana --no-warning .)
          echo "$output"
          score_line=$(echo "$output" | sed -n 's/^[[:space:]]*Points: //p' | head -n1)
          if [ -z "$score_line" ]; then
            echo "Could not parse pana score."
            exit 1
          fi
          got=${score_line%%/*}
          max=${score_line##*/}
          if [ "$got" -ne "$max" ]; then
            echo "pana score not perfect: $score_line"
            exit 1
          fi
